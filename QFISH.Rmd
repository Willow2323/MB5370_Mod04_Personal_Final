---
title: "QFISH"
author: "Riley Williams"
date: "2025-09-23"
output: html_document
---

```{r}
#Obtaining Packages
library(ggplot2)
library(tidyverse)
library(dplyr)
library(sf)
library (terra)
library(tmap)
library(patchwork)
library(cowplot)
```

```{r}
#Importing Data
raw <- read_excel("data/Shark Catch.xlsx", sheet = "export", skip = 1) #Importing the data and removing the first row
```

```{r}
#Tidying Data
raw <- raw %>% 
  select(-ends_with("Total"))#Removing columns that end with "Total"
raw <- raw %>% 
  filter(!`...1` %in% c("Grand Total", NA))
colnames(raw) #Checking column names
names(raw)[1] <- "Area" #Renaming the first column to "Area"
header_year <- read_excel("data/Shark Catch.xlsx", sheet = "export", n_max = 1) %>% unlist() #Extracting the first row
header_species <- colnames(raw) #Extracting the first row and column names
new_names <- ifelse(!is.na(header_year), paste(header_year, header_species, sep = "_"), header_species) #Combining the first row with the column names
names(raw) <- new_names #Combining the first row with the column names
raw <- raw %>% select(-contains("Total"), -contains("Grand")) #Removing columns that contain "Total" or "Grand"
raw <- raw %>% 
  select(-`...4`) #Removing the column "2001_...4 as it contained no data"
raw <- raw %>%
  filter(`2001_Area` != "Grand Total") #Removing the row "Grand Total"
#I noticed the data was still in the not format so had to do some more fidelling around
species_row <- raw[1, -1]    #Extracting the first row (species names) excluding the first column (Area)   
raw <- raw[-1, ]         #Removing the first row from the main data frame
colnames(raw)[-1] <- paste0(
  sub("\\.\\.\\..*", "", colnames(raw)[-1]),   
  "_",
  unlist(species_row)                           
) #Renaming columns by combining year and species names
raw_long <- raw %>%
  pivot_longer(
    cols = -Area,
    names_to = c("Year","SpeciesGroup"),
    names_sep = "_",
    values_to = "NumberCaught"
  ) %>%
  mutate(
    Year = as.integer(Year),
    NumberCaught = as.numeric(NumberCaught)
  ) %>%
  filter(!is.na(NumberCaught)) #Pivoting the data to long format
```

```{r}
#Plotting the Data
all_sites <- sort(unique(raw_long$Area))
my_cols <- setNames(grDevices::rainbow(length(all_sites)), all_sites)  # simple palette

# plotting function - hides legend on each panel
make_plot <- function(species_name) {
  raw_long %>%
    filter(SpeciesGroup == species_name) %>%
    ggplot(aes(x = Year, y = NumberCaught,
               colour = factor(Area, levels = all_sites),
               group = Area)) +
    geom_line() +
    geom_point() +
    scale_colour_manual(values = my_cols, drop = FALSE) + # keep consistent colours
    labs(title = species_name, x = "Year", y = "Number Caught", colour = "Site") +
    theme_minimal() +
    theme(legend.position = "none")   # hide per-plot legends
}

p_mammal <- make_plot("Mammal")
p_shark  <- make_plot("Shark")
p_turtle <- make_plot("Turtle")
p_other  <- make_plot("Other")

# Create a legend plot that contains all sites (it will be used only to extract the legend)
legend_plot <- ggplot(raw_long, aes(x = Year, y = NumberCaught,
                                    colour = Area)) +
  geom_point() +
  scale_colour_manual(values = my_cols, drop = FALSE) +
  guides(colour = guide_legend(ncol = 5, byrow = TRUE)) +  # change ncol to suit
  theme_void() +
  theme(legend.position = "bottom",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 8))

# extract legend grob
legend_grob <- cowplot::get_legend(legend_plot)

# make 2x2 grid of plots
grid <- cowplot::plot_grid(p_mammal, p_shark, p_turtle, p_other,
                           ncol = 2, align = "hv")

# stack the grid above the legend (adjust rel_heights to give more/less room to legend)
final_plot <- cowplot::plot_grid(grid, legend_grob,
                                ncol = 1, rel_heights = c(1, 0.2))

# display
print(final_plot)
cowplot::save_plot("catch_by_species_with_one_legend.png", final_plot,
                   base_height = 10, base_width = 12, dpi = 300)
```
